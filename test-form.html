<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Book Appointment - Durian-Quiamco Dental Clinic</title>
  <link href="https://fonts.googleapis.com/css?family=Kulim+Park:300,400,600,700&display=swap" rel="stylesheet">
  <style>
    /* Base */
    :root { --teal:#269A90; --text:#333; --muted:#777; --bg:#f7f9f9; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Kulim Park', sans-serif;
      color: var(--text);
      background: var(--bg);
    }

    /* Layout */
    .booking-section {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .booking-card {
      width: 100%;
      max-width: 980px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 2rem 2rem 2.4rem;
    }

    /* Steps */
    .booking-step { display: none; animation: stepFadeIn 280ms ease-out both; }
    .booking-step.active { display: block; }
    h2 {
      text-align: center;
      color: var(--teal);
      margin: 0 0 1.25rem;
      font-weight: 700;
    }

    /* Form anatomy */
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group { margin-bottom: 1rem; }
    .form-group label { font-weight: 600; display: block; margin-bottom: .5rem; }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: .8rem .9rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }
    .form-group textarea { resize: vertical; }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--teal);
      box-shadow: 0 0 0 3px rgba(38,154,144,.15);
    }

    /* Inline radios/checkboxes */
    .form-group-inline {
      margin-bottom: 1rem;
    }

    .inline-label {
      font-weight: 600;
      margin-right: 1rem;
    }

    .form-group-inline label {
      margin-right: 1rem;
      font-weight: 500;
      cursor: pointer;
    }

    /* Checkbox groups (Allergies) */
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: .75rem 1rem;
      margin-top: .5rem;
    }

    .checkbox-grid label {
      display: flex;
      align-items: center;
      gap: .5rem;
      font-weight: 500;
      cursor: pointer;
    }

    .checkbox-grid input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--teal);
    }

    /* Section headings inside form */
    .section-subheading {
      margin: 1.25rem 0 .75rem;
      padding-bottom: .35rem;
      border-bottom: 2px solid #eee;
      font-weight: 700;
      color: #444;
    }

    /* Buttons */
    .btn-primary {
      background: var(--teal);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: .9rem 1.6rem;
      font-size: 1.05rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform .08s ease, background .2s ease;
      font-family: 'Kulim Park', sans-serif;
    }
    .btn-primary:hover { background: #1f7f73; }
    .btn-primary:active { transform: translateY(1px); }
    .btn-primary:disabled { 
      background: #ccc; 
      cursor: not-allowed; 
      opacity: 0.7;
    }
    .wide { display: block; width: 100%; margin-top: .25rem; }

    /* Summary */
    .summary {
      background: #f5faf9;
      border: 1px dashed rgba(38,154,144,.35);
      color: #1c4e4a;
      padding: .75rem 1rem;
      border-radius: 10px;
      margin: .25rem 0 1.25rem;
      font-weight: 600;
    }

    /* Note */
    .submit-note {
      margin-top: .75rem;
      color: var(--muted);
      font-size: .95rem;
    }

    /* Form step animations */
    @keyframes stepFadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Success Modal Styles */
    #successModal {
      display: none !important;
    }

    #successModal.show {
      display: flex !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      justify-content: center !important;
      align-items: center !important;
      z-index: 999999 !important;
      background: linear-gradient(135deg, rgba(38, 154, 144, 0.95) 0%, rgba(50, 151, 139, 0.95) 100%) !important;
      animation: modalFadeIn 0.3s ease-out !important;
    }

    #successModal .modal-content {
      background: white !important;
      border-radius: 24px !important;
      max-width: 650px !important;
      width: 95% !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 10px 25px rgba(38, 154, 144, 0.2) !important;
      animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
      font-family: 'Kulim Park', Arial, sans-serif !important;
      position: relative !important;
      z-index: 1000000 !important;
      margin: 2rem !important;
    }

    #successModal .modal-content,
    #successModal .modal-content * {
      text-align: center !important;
    }

    #successModal .modal-header {
      background: linear-gradient(135deg, #269A90 0%, #32978b 50%, #1e8a80 100%) !important;
      padding: 3rem !important;
      text-align: center !important;
      border-radius: 24px 24px 0 0 !important;
      position: relative;
      overflow: hidden;
      width: 100% !important;
    }

    #successModal .modal-header h2 {
      font-size: 2.2rem !important;
      margin: 1.5rem auto 0 !important;
      font-weight: 700 !important;
      position: relative;
      z-index: 1;
      text-align: center !important;
      width: 100% !important;
      color: white !important;
    }

    #successModal .success-icon {
      margin: 0 auto 1.5rem !important;
      width: 100px !important;
      height: 100px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    #successModal .checkmark {
      width: 100px !important;
      height: 100px !important;
      border-radius: 50%;
      display: block;
      stroke-width: 3;
      stroke: white;
      stroke-miterlimit: 10;
      box-shadow: inset 0px 0px 0px white;
      animation: fill 0.4s ease-in-out 0.4s forwards, scale 0.3s ease-in-out 0.9s both;
      position: relative;
      filter: drop-shadow(0 4px 8px rgba(255, 255, 255, 0.3));
    }

    #successModal .checkmark-circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 3;
      stroke-miterlimit: 10;
      stroke: white;
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
      width: 100px !important;
      height: 100px !important;
      border-radius: 50%;
      position: absolute;
      top: 0;
      left: 0;
      border: 3px solid white;
    }

    #successModal .checkmark-stem {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
      position: absolute;
      top: 36px;
      left: 28px;
      width: 15px;
      height: 3px;
      background: white;
      transform: rotate(45deg);
    }

    #successModal .checkmark-kick {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.2s cubic-bezier(0.65, 0, 0.45, 1) 0.9s forwards;
      position: absolute;
      top: 44px;
      left: 35px;
      width: 25px;
      height: 3px;
      background: white;
      transform: rotate(-45deg);
    }

    #successModal .modal-body {
      padding: 3rem !important;
      text-align: center !important;
      background: linear-gradient(to bottom, #ffffff 0%, #f8fffe 100%) !important;
      line-height: 1.7 !important;
      width: 100% !important;
    }

    #successModal .main-message {
      font-size: 1.5rem !important;
      color: #269A90 !important;
      margin: 0 auto 1rem !important;
      font-weight: 600 !important;
      max-width: 500px !important;
      text-align: center !important;
      width: 100% !important;
    }

    #successModal .sub-message {
      font-size: 1.2rem !important;
      color: #666 !important;
      margin: 0 auto 2.5rem !important;
      max-width: 450px !important;
      text-align: center !important;
      width: 100% !important;
    }

    #successModal .next-steps {
      background: linear-gradient(135deg, #f0f9f8 0%, #e8f5f4 100%) !important;
      border: 1px solid rgba(38, 154, 144, 0.1) !important;
      box-shadow: 0 2px 10px rgba(38, 154, 144, 0.05) !important;
      padding: 2rem !important;
      border-radius: 16px !important;
      margin: 2rem auto !important;
      max-width: 500px !important;
      width: calc(100% - 4rem) !important;
      text-align: center !important;
    }

    #successModal .next-steps h4 {
      color: #269A90 !important;
      margin: 0 auto 1.5rem !important;
      font-size: 1.3rem !important;
      text-align: center !important;
      font-weight: 700 !important;
      width: 100% !important;
    }

    #successModal .next-steps ul {
      list-style: none !important;
      padding: 0 !important;
      margin: 0 auto !important;
      max-width: 400px !important;
      text-align: center !important;
    }

    #successModal .next-steps li {
      padding: 0.8rem 0 !important;
      color: #555 !important;
      font-size: 1.1rem !important;
      text-align: center !important;
      width: 100% !important;
    }

    #successModal .contact-info {
      background: rgba(38, 154, 144, 0.05) !important;
      padding: 2rem !important;
      border-radius: 16px !important;
      margin: 2rem auto 0 !important;
      border: 1px solid rgba(38, 154, 144, 0.1) !important;
      text-align: center !important;
      max-width: 500px !important;
      width: 100% !important;
    }

    #successModal .contact-info p {
      font-size: 1.1rem !important;
      margin: 0 auto !important;
      text-align: center !important;
    }

    #successModal .contact-info a {
      font-weight: 700 !important;
      text-decoration: none !important;
      color: #269A90 !important;
      font-size: 1.2rem !important;
      position: relative !important;
      display: inline-block !important;
    }

    #successModal .modal-footer {
      padding: 3rem !important;
      display: flex !important;
      gap: 1.5rem !important;
      justify-content: center !important;
      align-items: center !important;
      background: #f8f9fa !important;
      border-radius: 0 0 24px 24px !important;
      text-align: center !important;
      width: 100% !important;
    }

    #successModal .modal-footer button {
      padding: 1rem 2.5rem !important;
      border: none !important;
      border-radius: 12px !important;
      font-weight: 600 !important;
      cursor: pointer !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      font-family: 'Kulim Park', Arial, sans-serif !important;
      font-size: 1.1rem !important;
      min-width: 140px !important;
      text-align: center !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    #successModal .modal-footer .btn-primary {
      background: linear-gradient(135deg, #269A90 0%, #32978b 100%) !important;
      color: white !important;
      box-shadow: 0 4px 15px rgba(38, 154, 144, 0.3) !important;
    }

    .btn-secondary {
      background: transparent !important;
      color: #269A90 !important;
      border: 2px solid #269A90 !important;
      box-shadow: 0 2px 10px rgba(38, 154, 144, 0.1) !important;
    }

    .btn-secondary:hover {
      background: #269A90 !important;
      color: white !important;
      box-shadow: 0 4px 15px rgba(38, 154, 144, 0.3) !important;
      transform: translateY(-1px) !important;
    }

    /* Error Message Styles */
    .error-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      max-width: 400px;
      z-index: 1000000;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
    }

    /* Modal Animations */
    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes modalSlideIn {
      from { 
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes stroke {
      100% {
        stroke-dashoffset: 0;
      }
    }

    @keyframes scale {
      0%, 100% {
        transform: none;
      }
      50% {
        transform: scale3d(1.1, 1.1, 1);
      }
    }

    @keyframes fill {
      100% {
        box-shadow: inset 0px 0px 0px 30px white;
      }
    }

    /* Responsive */
    @media (max-width: 860px) { 
      .checkbox-grid { 
        grid-template-columns: repeat(2,1fr); 
      } 
    }

    @media (max-width: 768px) {
      .form-row { 
        grid-template-columns: 1fr; 
      }
      .booking-card { 
        padding: 1.5rem 1.25rem; 
        border-radius: 12px; 
      }
      
      #successModal .modal-content {
        margin: 1rem !important;
        width: calc(100% - 2rem) !important;
        border-radius: 20px !important;
      }
      
      #successModal .modal-footer {
        flex-direction: column !important;
        padding: 2rem !important;
      }
      
      #successModal .modal-footer button {
        width: 100% !important;
        max-width: 300px !important;
      }
    }
  </style>
</head>
<body>
  <section class="booking-section">
    <div class="booking-card">
      <!-- STEP 1: Date & Time -->
      <div class="booking-step active" id="step1">
        <h2>Select Date & Time</h2>

        <div class="form-row">
          <div class="form-group">
            <label for="appointmentDate">Choose a date</label>
            <input type="date" id="appointmentDate" required />
          </div>

          <div class="form-group">
            <label for="appointmentTime">Choose a time</label>
            <select id="appointmentTime" required>
              <option value="">-- Select a time --</option>
              <option value="09:00">9:00 AM</option>
              <option value="10:00">10:00 AM</option>
              <option value="11:00">11:00 AM</option>
              <option value="13:00">1:00 PM</option>
              <option value="14:00">2:00 PM</option>
              <option value="15:00">3:00 PM</option>
              <option value="16:00">4:00 PM</option>
            </select>
          </div>
        </div>

        <button class="btn-primary wide" id="goNext" onclick="handleNextClick()">Next</button>
      </div>

      <!-- STEP 2: Patient Information -->
      <div class="booking-step" id="step2">
        <h2>Durian-Quiamco Patient Information</h2>

        <div class="summary" id="apptSummary"></div>

        <form id="bookingForm" method="POST">
          <input type="hidden" name="appointment_date" id="hiddenAppointmentDate" />
          <input type="hidden" name="appointment_time" id="hiddenAppointmentTime" />

          <!-- Personal Information -->
          <div class="section-subheading">Personal Information</div>

          <div class="form-group">
            <label for="name">Full Name*</label>
            <input type="text" id="name" name="name" autocomplete="off" required />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="birthdate">Birthdate*</label>
              <input type="date" id="birthdate" name="birthdate" required />
            </div>
            <div class="form-group">
              <label for="age">Age*</label>
              <input type="number" id="age" name="age" min="0" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="sex">Sex*</label>
              <select id="sex" name="sex" required>
                <option value="">Select</option>
                <option>Male</option>
                <option>Female</option>
              </select>
            </div>
            <div class="form-group">
              <label for="religion">Religion</label>
              <input type="text" id="religion" name="religion" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="nationality">Nationality</label>
              <input type="text" id="nationality" name="nationality" />
            </div>
            <div class="form-group">
              <label for="occupation">Occupation</label>
              <input type="text" id="occupation" name="occupation" />
            </div>
          </div>

          <div class="form-group">
            <label for="homeAddress">Home Address*</label>
            <input type="text" id="homeAddress" name="homeAddress" required />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="mobile">Mobile No.*</label>
              <input type="tel" id="mobile" name="mobile" required />
            </div>
            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" name="email" autocomplete="off"/>
            </div>
          </div>

          <div class="form-group">
            <label for="referrer">Referred By</label>
            <input type="text" id="referrer" name="referrer" />
          </div>

          <!-- Dental History -->
          <div class="section-subheading">Dental History</div>

          <div class="form-row">
            <div class="form-group">
              <label for="prevDentist">Previous Dentist</label>
              <input type="text" id="prevDentist" name="prevDentist" />
            </div>
            <div class="form-group">
              <label for="lastVisit">Last Dental Visit</label>
              <input type="date" id="lastVisit" name="lastVisit" />
            </div>
          </div>

          <div class="form-group">
            <label for="reason">Reason for Consultation</label>
            <textarea id="reason" name="reason" rows="3"></textarea>
          </div>

          <!-- Medical History -->
          <div class="section-subheading">Medical History</div>

          <div class="form-row">
            <div class="form-group">
              <label for="physician">Physician Name</label>
              <input type="text" id="physician" name="physician" />
            </div>
            <div class="form-group">
              <label for="physicianOffice">Office / Contact</label>
              <input type="text" id="physicianOffice" name="physicianOffice" />
            </div>
          </div>

          <div class="form-group">
            <label for="medications">Current Medications</label>
            <textarea id="medications" name="medications" rows="2"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="bloodType">Blood Type</label>
              <select id="bloodType" name="bloodType">
                <option value="">Select</option>
                <option>A+</option>
                <option>A-</option>
                <option>B+</option>
                <option>B-</option>
                <option>AB+</option>
                <option>AB-</option>
                <option>O+</option>
                <option>O-</option>
              </select>
            </div>
            <div class="form-group">
              <label for="bloodPressure">Blood Pressure</label>
              <input type="text" id="bloodPressure" name="bloodPressure" placeholder="e.g., 120/80" />
            </div>
          </div>

          <!-- Medical Conditions -->
          <div class="form-group-inline">
            <span class="inline-label">Are you under medical treatment?</span>
            <label><input type="radio" name="medicalTreatment" value="Yes" id="gHealthN"/> Yes</label>
            <label><input type="radio" name="medicalTreatment" value="No" id="gHealthY"/> No</label>
          </div>

          <div class="form-group">
            <label for="medCondition">If yes, specify condition:</label>
            <textarea id="medCondition" name="medCondition" rows="2" disabled></textarea>
          </div>

          <div class="form-group-inline">
            <span class="inline-label">Have you had surgery?</span>
            <label><input type="radio" name="surgery" value="Yes" id="hoSurY"/> Yes</label>
            <label><input type="radio" name="surgery" value="No" id="hoSurN"/> No</label>
          </div>

          <div class="form-group">
            <label for="surgeryDetails">If yes, specify surgery details:</label>
            <textarea id="surgeryDetails" name="surgeryDetails" rows="2" disabled></textarea>
          </div>

          <!-- Women's Health -->
          <div class="form-group-inline">
            <span class="inline-label">Pregnant?</span>
            <label><input type="checkbox" name="pregnant" value="Yes" id="pregy"/> Yes</label>
          </div>

          <div class="form-group-inline">
            <span class="inline-label">Nursing?</span>
            <label><input type="checkbox" name="nursing" value="Yes" id="nurs"/> Yes</label>
          </div>

          <div class="form-group-inline">
            <span class="inline-label">Using birth control pills?</span>
            <label><input type="checkbox" name="birthControl" value="Yes" id="bcpills"/> Yes</label>
          </div>

          <!-- Allergies -->
          <div class="section-subheading">Allergies</div>
          <div class="checkbox-grid">
            <label><input type="checkbox" id="locAnesth" name="allergy[]" value="Local Anesthetic"/> Local Anesthetic</label>
            <label><input type="checkbox" id="aspirin" name="allergy[]" value="Aspirin"/> Aspirin</label>
            <label><input type="checkbox" id="penicillin" name="allergy[]" value="Penicillin"/> Penicillin</label>
            <label><input type="checkbox" id="latex" name="allergy[]" value="Latex"/> Latex</label>
            <label><input type="checkbox" id="sulfa" name="allergy[]" value="Sulfa drugs"/> Sulfa drugs</label>
            <label><input type="checkbox" id="otherAllergiesCB" name="allergy[]" value="Other"/> Other</label>
          </div>

          <div class="form-group">
            <label for="otherAllergies">If other, please specify:</label>
            <input type="text" id="otherAllergies" name="otherAllergies" disabled />
          </div>

          <button type="submit" class="btn-primary wide">Submit Appointment</button>
          <p class="submit-note">This form will be sent securely. You can finalize the schedule after confirmation.</p>
        </form>
      </div>
    </div>
  </section>

  <!-- SUCCESS MODAL -->
  <div id="successModal" class="modal-overlay" style="display:none">
    <div class="modal-content">
        <div class="modal-header">
            <div class="success-icon">
                <div class="checkmark">
                    <div class="checkmark-circle"></div>
                    <div class="checkmark-stem"></div>
                    <div class="checkmark-kick"></div>
                </div>
            </div>
            <h2>Registration Successful!</h2>
        </div>
        
        <div class="modal-body">
            <p class="main-message">Thank you for choosing <strong>Durian-Quiamco Dental Clinic</strong>!</p>
            <p class="sub-message">Your appointment registration has been successfully submitted.</p>
            
            <div class="next-steps">
                <h4>What happens next?</h4>
                <ul>
                    <li>Our team will contact you within 24 hours to confirm your appointment</li>
                    <li>Please bring a valid ID and any relevant medical records</li>
                    <li>Arrive 15 minutes early for your appointment</li>
                </ul>
            </div>
            
            <div class="contact-info">
                <p><strong>Questions?</strong> Call us at <a href="tel:09216467594">09216467594</a></p>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn-primary" onclick="closeSuccessModal()">Continue</button>
            <button class="btn-secondary" onclick="goHome()">Back to Home</button>
        </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // DOM Elements
      const elements = {
        nextBtn: document.getElementById('goNext'),
        step1: document.getElementById('step1'),
        step2: document.getElementById('step2'),
        dateInput: document.getElementById('appointmentDate'),
        timeSelect: document.getElementById('appointmentTime'),
        summary: document.getElementById('apptSummary'),
        hiddenDate: document.getElementById('hiddenAppointmentDate'),
        hiddenTime: document.getElementById('hiddenAppointmentTime'),
        form: document.getElementById('bookingForm')
      };

      // Initialize form
      initializeForm();
      setupEventListeners();

      /**
       * Initialize form with default settings
       */
      function initializeForm() {
        const today = new Date();
        const minDate = today.toISOString().split('T')[0];
        elements.dateInput.min = minDate;
      }

      /**
       * Set up all event listeners
       */
      function setupEventListeners() {
        console.log('Setting up event listeners...');
        console.log('Next button element:', elements.nextBtn);
        
        if (elements.nextBtn) {
          elements.nextBtn.addEventListener('click', handleNextStep);
          console.log('Next button event listener added');
        } else {
          console.error('Next button not found!');
        }
        
        if (elements.form) {
          elements.form.addEventListener('submit', handleFormSubmit);
          console.log('Form submit event listener added');
        } else {
          console.error('Form not found!');
        }
        
        setupMedicalHistoryToggles();
        setupAllergiesToggle();
        setupModalControls();
      }

      /**
       * Handle step navigation
       */
      function handleNextStep(e) {
        e.preventDefault();
        console.log('Next button clicked');
        
        const dateVal = elements.dateInput.value;
        const timeVal = elements.timeSelect.value;

        console.log('Date:', dateVal, 'Time:', timeVal);

        if (!dateVal || !timeVal) {
          alert('Please select both a date and a time.');
          return;
        }

        elements.hiddenDate.value = dateVal;
        elements.hiddenTime.value = timeVal;

        const prettyTime = formatTime(timeVal);
        const prettyDate = formatDate(dateVal);
        elements.summary.textContent = `Appointment: ${prettyDate} at ${prettyTime}`;

        elements.step1.classList.remove('active');
        elements.step2.classList.add('active');
      }

      /**
       * Handle form submission
       */
      function handleFormSubmit(e) {
        e.preventDefault();
        submitDataToDB();
      }

      /**
       * Set up medical history radio button toggles
       */
      function setupMedicalHistoryToggles() {
        const medicalToggles = [
          { yes: 'gHealthN', no: 'gHealthY', target: 'medCondition' },
          { yes: 'hoSurY', no: 'hoSurN', target: 'surgeryDetails' }
        ];

        medicalToggles.forEach(toggle => {
          const yesElement = document.getElementById(toggle.yes);
          const noElement = document.getElementById(toggle.no);
          const targetElement = document.getElementById(toggle.target);

          if (yesElement && targetElement) {
            yesElement.addEventListener('change', () => {
              targetElement.disabled = false;
            });
          }

          if (noElement && targetElement) {
            noElement.addEventListener('change', () => {
              targetElement.disabled = true;
              targetElement.value = '';
            });
          }
        });
      }

      /**
       * Set up allergies "other" option toggle
       */
      function setupAllergiesToggle() {
        const otherAllergiesCB = document.getElementById('otherAllergiesCB');
        const otherAllergiesInput = document.getElementById('otherAllergies');

        if (otherAllergiesCB && otherAllergiesInput) {
          otherAllergiesCB.addEventListener('change', () => {
            otherAllergiesInput.disabled = !otherAllergiesCB.checked;
            if (!otherAllergiesCB.checked) {
              otherAllergiesInput.value = '';
            }
          });
        }
      }

      /**
       * Set up modal controls
       */
      function setupModalControls() {
        document.addEventListener('click', (e) => {
          const modal = document.getElementById('successModal');
          if (modal && e.target === modal) {
            closeSuccessModal();
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            closeSuccessModal();
          }
        });
      }

      /**
       * Collect and validate form data
       */
      function collectFormData() {
        const getValue = (id) => {
          const element = document.getElementById(id);
          return element ? element.value.trim() : '';
        };

        const getOptionalValue = (value) => {
          return value || 'N/A';
        };

        const getRadioValue = (name) => {
          const element = document.querySelector(`input[name="${name}"]:checked`);
          return element ? element.value : 'No';
        };

        const getCheckboxValue = (id) => {
          const element = document.getElementById(id);
          return element && element.checked ? 'Yes' : 'No';
        };

        return {
          // Appointment details
          appointment_date: elements.hiddenDate.value,
          appointment_time: elements.hiddenTime.value,

          // Required fields
          name: getValue('name'),
          birthdate: getValue('birthdate'),
          age: getValue('age'),
          sex: getValue('sex'),
          homeAddress: getValue('homeAddress'),
          mobile: getValue('mobile'),

          // Optional fields
          religion: getOptionalValue(getValue('religion')),
          nationality: getOptionalValue(getValue('nationality')),
          occupation: getOptionalValue(getValue('occupation')),
          email: getOptionalValue(getValue('email')),
          refBy: getOptionalValue(getValue('referrer')),
          prevDent: getOptionalValue(getValue('prevDentist')),
          lastDentVisit: getValue('lastVisit') || new Date().toISOString().split('T')[0],
          resForConsult: getOptionalValue(getValue('reason')),
          physician: getOptionalValue(getValue('physician')),
          officeContact: getOptionalValue(getValue('physicianOffice')),
          medications: getOptionalValue(getValue('medications')),
          bloodType: getOptionalValue(getValue('bloodType')),
          bloodPressure: getOptionalValue(getValue('bloodPressure')),

          // Medical conditions
          undr_trtmnt: document.getElementById('gHealthN')?.checked ? 
            getOptionalValue(getValue('medCondition')) : 'N/A',
          surgery: document.getElementById('hoSurY')?.checked ? 
            getOptionalValue(getValue('surgeryDetails')) : 'N/A',

          // Women's health
          pregy: getCheckboxValue('pregy'),
          nurs: getCheckboxValue('nurs'),
          bcpills: getCheckboxValue('bcpills'),

          // Allergies
          allergy: collectAllergies()
        };
      }

      /**
       * Collect allergies information
       */
      function collectAllergies() {
        const allergyIds = ['locAnesth', 'aspirin', 'penicillin', 'latex', 'sulfa'];
        const allergies = [];

        allergyIds.forEach(id => {
          const element = document.getElementById(id);
          if (element && element.checked) {
            allergies.push(element.value);
          }
        });

        // Check for other allergies
        const otherAllergiesCB = document.getElementById('otherAllergiesCB');
        const otherAllergiesValue = document.getElementById('otherAllergies');
        
        if (otherAllergiesCB?.checked && otherAllergiesValue?.value.trim()) {
          allergies.push(otherAllergiesValue.value.trim());
        }

        return allergies.length > 0 ? allergies.join(', ') : 'None';
      }

      /**
       * Submit form data to database
       */
      async function submitDataToDB() {
        const formData = collectFormData();
        const submitButton = document.querySelector('button[type="submit"]');
        
        // Show loading state
        setButtonLoading(submitButton, true);

        try {
          const response = await fetch('js/personal_info_to_db.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(formData).toString()
          });

          const responseText = await response.text();
          
          if (response.ok && (responseText.includes('Personal details saved') || responseText.includes('saved'))) {
            showSuccessModal();
          } else {
            showErrorMessage(`Submission failed: ${responseText}`);
          }

        } catch (error) {
          showErrorMessage(`Network error: ${error.message}`);
        } finally {
          setButtonLoading(submitButton, false);
        }
      }

      /**
       * Set button loading state
       */
      function setButtonLoading(button, isLoading) {
        if (!button) return;

        if (isLoading) {
          button.disabled = true;
          button.dataset.originalText = button.textContent;
          button.textContent = 'Submitting...';
          button.style.opacity = '0.7';
        } else {
          button.disabled = false;
          button.textContent = button.dataset.originalText || 'Submit Appointment';
          button.style.opacity = '1';
        }
      }

      /**
       * Format time for display
       */
      function formatTime(timeString) {
        const [hours, minutes] = timeString.split(':').map(Number);
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHours = ((hours + 11) % 12) + 1;
        return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
      }

      /**
       * Format date for display
       */
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString(undefined, { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
      }

      /**
       * Show success modal
       */
      function showSuccessModal() {
        const modal = document.getElementById('successModal');
        if (!modal) return;

        modal.style.cssText = `
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          display: flex !important;
          justify-content: center !important;
          align-items: center !important;
          z-index: 999999 !important;
          background: linear-gradient(135deg, rgba(38, 154, 144, 0.95) 0%, rgba(50, 151, 139, 0.95) 100%) !important;
        `;

        modal.classList.add('show');
        document.body.style.overflow = 'hidden';

        setTimeout(() => {
          const continueBtn = modal.querySelector('.btn-primary');
          if (continueBtn) continueBtn.focus();
        }, 500);
      }

      /**
       * Close success modal
       */
      function closeSuccessModal() {
        const modal = document.getElementById('successModal');
        if (!modal) return;

        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.style.overflow = '';

        // Reset form
        setTimeout(() => {
          elements.form.reset();
          
          elements.step2.classList.remove('active');
          elements.step1.classList.add('active');
          
          elements.summary.textContent = '';
        }, 100);
      }

      /**
       * Navigate to home page
       */
      function goHome() {
        // In a real implementation, this would redirect to your actual home page
        window.location.href = 'index.html';
      }

      /**
       * Show error message
       */
      function showErrorMessage(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;

        document.body.appendChild(errorDiv);

        // Auto-remove and click to dismiss
        const removeError = () => errorDiv.remove();
        errorDiv.addEventListener('click', removeError);
        setTimeout(removeError, 8000);
      }

      // Make functions globally accessible for HTML onclick handlers
      window.closeSuccessModal = closeSuccessModal;
      window.goHome = goHome;
      window.handleNextClick = function() {
        console.log('Global handleNextClick called');
        handleNextStep({ preventDefault: () => {} });
      };
    });
  </script>
</body>
</html>